{% load image_filters %}
{% if videos %}

<div class="container my-4">

    <h2 class="news-strip">WATCH MIDDLE EAST</h2>

    <div class="row watch-wrapper">

        <!-- LEFT MAIN VIDEO -->
        <div class="col-lg-8 col-md-12 col-sm-12">
            {% with videos.0 as main %}
            <div class="watch-left">

                <div class="video-box" id="videoBox" data-url="{{ main.video_url }}">
                    <img src="{{ main.video_thumbnail.url }}" class="main-thumb" id="mainThumb">
                    <div class="play-btn" id="playOverlay">
                        <i class="fa fa-play"></i>
                    </div>
                </div>

                <div class="card-bg-dark video-info text-start desktop-info">
                    <h4 id="mainTitle">{{ main.video_title }}</h4>
                    <p id="mainDesc">{{ main.video_short_des }}</p>
                </div>

            </div>
            {% endwith %}
        </div>

        <!-- RIGHT SIDE LIST -->
        <div class="col-lg-4 col-md-12 col-sm-12">
            <div class="watch-right">
                {% for video in videos %}
                <div class="side-item {% if forloop.first %}active{% endif %}"
                    data-url="{{ video.video_url }}"
                    data-title="{{ video.video_title|escapejs }}"
                    data-desc="{{ video.video_short_des|escapejs }}"
                    data-thumb="{{ video.video_thumbnail.url }}">

                    <img src="{{ video.video_thumbnail.url }}">
                    <div class="side-text text-start fs-6">
                        {{ video.video_title|truncatewords:10 }}
                    </div>

                </div>
                {% endfor %}
            </div>
            <div class="ad-box-h mt-4">ADVERTISEMENT</div>
        </div>

    </div>
</div>

{% endif %}

<style>

/* ================= WATCH SECTION ================= */

.watch-wrapper{
  align-items: stretch;
}

.video-box{
  position: relative;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
  aspect-ratio: 16/9;
  cursor: pointer;
}

.main-thumb{
  width:100%;
  height:100%;
  object-fit:cover;
}

.play-btn{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:85px;
  height:85px;
  border-radius:50%;
  background:rgba(255,0,0,.85);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size:30px;
  box-shadow:0 15px 40px rgba(0,0,0,.4);
  transition:.3s;
}

.play-btn:hover{
  transform:translate(-50%,-50%) scale(1.1);
}

.watch-right{
  background:#1c1c1c;
  padding:12px;
  max-height: 100%;
  overflow-y:auto;
  border-radius: 10px;
}

.side-item{
  display:flex;
  gap:10px;
  padding:10px;
  margin-bottom:18px;
  background:#2b2b2b;
  color:#fff;
  cursor:pointer;
  transition:.3s;
  line-height: 19px;
}

.side-item img{
  width:120px;
  height:70px;
  object-fit:cover;
}

.side-item.active{
  background:#cc1227;
}

.side-item:hover{
  background:#444;
}

#videoBox iframe{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
}

/* ================= MOBILE VERSION ================= */

@media(max-width:768px){

  .desktop-info{
    display:none;   /* hide title + description */
  }

  .watch-right{
    display:flex;
    overflow-x:auto;
    overflow-y:hidden;
    gap:12px;
    padding:10px 0;
    background:transparent;
  }

  .watch-right::-webkit-scrollbar{
    display:none;
  }

  .side-item{
    flex-direction:column;
    min-width:220px;
    background:transparent;
    padding:0;
  }

  .side-item img{
    width:100%;
    height:130px;
    border-radius:8px;
  }

  .side-text{
    display:none;   /* hide title on mobile */
  }

}

</style>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let currentVideoId = null;
let shouldAutoplay = 0;
let firstVideoUrl = null;

function onYouTubeIframeAPIReady() {
    const videoBox = document.getElementById("videoBox");
    if (videoBox) {
        firstVideoUrl = videoBox.getAttribute("data-url");
    }
    initializePlayer();
}

function initializePlayer() {
    currentVideoId = extractVideoId(firstVideoUrl);
    if (!currentVideoId) return;

    player = new YT.Player("videoBox", {
        height: "460",
        width: "100%",
        videoId: currentVideoId,
        playerVars: {
            autoplay: shouldAutoplay,
            rel: 0
        },
        events: {
            'onReady': function (event) {
                const playOverlay = document.getElementById("playOverlay");
                if (playOverlay) {
                    playOverlay.addEventListener("click", function () {

                        // ✅ Play button — sidebar jaisi same functionality
                        shouldAutoplay = 1;

                        // Overlay aur thumbnail hide karo
                        playOverlay.style.display = "none";
                        const thumb = document.getElementById("mainThumb");
                        if (thumb) thumb.style.display = "none";

                        // loadVideoById se play karo — sidebar jaisa
                        if (player && player.loadVideoById) {
                            player.loadVideoById(currentVideoId);
                        }
                    });
                }
            },
            'onError': function (event) {
                window.open(`https://www.youtube.com/watch?v=${currentVideoId}`, "_blank");
            }
        }
    });
}

function extractVideoId(url) {
    if (!url) return null;
    if (url.length === 11 && !url.includes("http")) return url;
    const regExp = /^.*((youtu.be\/)|(v\/)|(embed\/)|(watch\?v=)|(shorts\/))([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[6].length === 11) ? match[6] : null;
}

function changeVideo(url) {
    const id = extractVideoId(url);
    if (!id) return;

    currentVideoId = id;
    shouldAutoplay = 1;

    // Overlay aur thumbnail hide karo
    const playOverlay = document.getElementById("playOverlay");
    const thumb = document.getElementById("mainThumb");
    if (playOverlay) playOverlay.style.display = "none";
    if (thumb) thumb.style.display = "none";

    if (player && player.loadVideoById) {
        player.loadVideoById(id);
    } else {
        firstVideoUrl = url;
        initializePlayer();
    }
}

document.addEventListener("DOMContentLoaded", function () {

    const mainTitle = document.getElementById("mainTitle");
    const mainDesc = document.getElementById("mainDesc");

    document.querySelectorAll(".side-item").forEach(item => {
        item.addEventListener("click", function () {

            const url = this.getAttribute("data-url");
            if (!url) return;

            mainTitle.innerText = this.getAttribute("data-title") || "";
            mainDesc.innerText = this.getAttribute("data-desc") || "";

            changeVideo(url);

            document.querySelectorAll(".side-item").forEach(el => el.classList.remove("active"));
            this.classList.add("active");
        });
    });

});
</script>
