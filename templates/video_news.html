{% load image_filters %}
{% if videos %}

<div class="container my-5">

    <h2 class="news-strip">WATCH MIDDLE EAST</h2>

    <div class="watch-wrapper">

        {% with videos.0 as main %}
        <div class="watch-left">

            <div class="video-box" id="videoBox" data-url="{{ main.video_url }}">
                <img src="{{ main.video_thumbnail.url }}" class="main-thumb" id="mainThumb">
                <div class="play-btn" id="playOverlay">▶</div>
            </div>

            <div class="video-info mt-2">
                <h2 id="mainTitle">{{ main.video_title|truncatewords:20 }}</h2>
                <p id="mainDesc">{{ main.video_short_des|truncatewords:30 }}</p>
            </div>

        </div>
        {% endwith %}

        <div class="watch-right">
            {% for video in videos %}
            <div class="side-item {% if forloop.first %}active{% endif %}"
                 data-url="{{ video.video_url }}"
                 data-title="{{ video.video_title|escapejs }}"
                 data-desc="{{ video.video_short_des|escapejs }}"
                 data-thumb="{{ video.video_thumbnail.url }}">

                <img src="{{ video.video_thumbnail.url }}">
                <div class="text-left fs-6">
                    {{ video.video_title|truncatewords:10 }}
                </div>
            </div>
            {% endfor %}
        </div>

    </div>
</div>

{% endif %}

<style>

.watch-wrapper {
    display: flex;
    gap: 20px;
}

.watch-left {
    flex: 3;
}

.video-box {
    position: relative;
    height: 460px;
    background: black;
    border-radius: 6px;
    overflow: hidden;
    cursor: pointer;
}

.main-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.play-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background: rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 38px;
    pointer-events: all;
    cursor: pointer;
    z-index: 10;
}

.video-info h2,
.video-info p {
    text-align: left;
}

.watch-right {
    flex: 1.3;
    background: #1c1c1c;
    padding: 12px;
    max-height: 460px;
    overflow-y: auto;
}

.side-item {
    display: flex;
    gap: 10px;
    padding: 10px;
    margin-bottom: 12px;
    cursor: pointer;
    background: #2b2b2b;
    color: white;
    transition: .3s;
}

.side-item img {
    width: 120px;
    height: 70px;
    object-fit: cover;
}

.side-item.active {
    background: #cd162a;
}

.side-item:hover {
    background: #444;
}

#videoBox iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100% !important;
    height: 100% !important;
}

@media(max-width:992px){
    .watch-wrapper {
        flex-direction: column;
    }
}

</style>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
let currentVideoId = null;
let shouldAutoplay = 0;
let firstVideoUrl = null;

function onYouTubeIframeAPIReady() {
    const videoBox = document.getElementById("videoBox");
    if (videoBox) {
        firstVideoUrl = videoBox.getAttribute("data-url");
    }
    initializePlayer();
}

function initializePlayer() {
    currentVideoId = extractVideoId(firstVideoUrl);
    if (!currentVideoId) return;

    player = new YT.Player("videoBox", {
        height: "460",
        width: "100%",
        videoId: currentVideoId,
        playerVars: {
            autoplay: shouldAutoplay,
            rel: 0
        },
        events: {
            'onReady': function (event) {
                const playOverlay = document.getElementById("playOverlay");
                if (playOverlay) {
                    playOverlay.addEventListener("click", function () {

                        // ✅ Play button — sidebar jaisi same functionality
                        shouldAutoplay = 1;

                        // Overlay aur thumbnail hide karo
                        playOverlay.style.display = "none";
                        const thumb = document.getElementById("mainThumb");
                        if (thumb) thumb.style.display = "none";

                        // loadVideoById se play karo — sidebar jaisa
                        if (player && player.loadVideoById) {
                            player.loadVideoById(currentVideoId);
                        }
                    });
                }
            },
            'onError': function (event) {
                window.open(`https://www.youtube.com/watch?v=${currentVideoId}`, "_blank");
            }
        }
    });
}

function extractVideoId(url) {
    if (!url) return null;
    if (url.length === 11 && !url.includes("http")) return url;
    const regExp = /^.*((youtu.be\/)|(v\/)|(embed\/)|(watch\?v=)|(shorts\/))([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[6].length === 11) ? match[6] : null;
}

function changeVideo(url) {
    const id = extractVideoId(url);
    if (!id) return;

    currentVideoId = id;
    shouldAutoplay = 1;

    // Overlay aur thumbnail hide karo
    const playOverlay = document.getElementById("playOverlay");
    const thumb = document.getElementById("mainThumb");
    if (playOverlay) playOverlay.style.display = "none";
    if (thumb) thumb.style.display = "none";

    if (player && player.loadVideoById) {
        player.loadVideoById(id);
    } else {
        firstVideoUrl = url;
        initializePlayer();
    }
}

document.addEventListener("DOMContentLoaded", function () {

    const mainTitle = document.getElementById("mainTitle");
    const mainDesc = document.getElementById("mainDesc");

    document.querySelectorAll(".side-item").forEach(item => {
        item.addEventListener("click", function () {

            const url = this.getAttribute("data-url");
            if (!url) return;

            mainTitle.innerText = this.getAttribute("data-title") || "";
            mainDesc.innerText = this.getAttribute("data-desc") || "";

            changeVideo(url);

            document.querySelectorAll(".side-item").forEach(el => el.classList.remove("active"));
            this.classList.add("active");
        });
    });

});
</script>